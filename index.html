<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>智能居住</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --panel-2:#0b1329;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee; --danger:#ef4444; --ok:#34d399; --warn:#f59e0b;
      --ring:rgba(34,211,238,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text); background: radial-gradient(1200px 800px at 20% -10%, #1c2a4a 0%, transparent 60%) , var(--bg);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:24px}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px;}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 220deg,#22d3ee,#0ea5e9,#22d3ee);box-shadow:0 10px 30px rgba(34,211,238,.25) inset, 0 0 0 1px rgba(255,255,255,.05) inset;}
    h1{font-size:18px; margin:0; font-weight:700; letter-spacing:.2px}
    .muted{color:var(--muted); font-size:12px}

    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:18px}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr; } }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      border:1px solid rgba(255,255,255,.06);
      border-radius:16px; padding:16px;
      box-shadow:0 6px 30px rgba(0,0,0,.2), 0 1px 0 rgba(255,255,255,.04) inset;
    }
    .card-title{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px}
    .card-title h2{font-size:14px; margin:0; font-weight:700; letter-spacing:.3px}

    /* 关键：让容器足够大、可滚动；适应/原始切换时使用 */
    .videoWrap{
      height: clamp(420px, 62vh, 78vh);       /* 自适应变大 */
      background: repeating-conic-gradient(#0c152c 0 12deg, #0b1329 12deg 24deg);
      border-radius:12px; overflow:auto;      /* 原始尺寸时可滚动查看 */
      display:flex; align-items:center; justify-content:center;
      position:relative; border:1px solid rgba(255,255,255,.06);
    }
    /* 关键：让图片在“适应模式”时填满容器并等比缩放 */
    .videoWrap img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }
    .badge{
      position:absolute; top:10px; left:10px; font-size:12px; padding:6px 10px; border-radius:999px;
      background:rgba(15,23,42,.65); border:1px solid rgba(255,255,255,.08); backdrop-filter: blur(5px);
    }
    .badge.ok{color:#10b981; border-color:rgba(16,185,129,.35)}
    .badge.warn{color:#f59e0b; border-color:rgba(245,158,11,.35)}
    .badge.err{color:#ef4444; border-color:rgba(239,68,68,.35)}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{font-size:12px; color:var(--muted)}
    input,select{
      color:var(--text); background:var(--panel);
      border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:10px 12px; outline:none; min-width:160px;
    }
    input:focus,select:focus{box-shadow:0 0 0 3px var(--ring)}
    .btn{
      border:1px solid rgba(255,255,255,.12); padding:10px 14px; border-radius:10px; cursor:pointer;
      background: linear-gradient(180deg, rgba(34,211,238,.2), rgba(34,211,238,.08));
      color:var(--text); font-weight:700; letter-spacing:.2px;
    }
    .btn.secondary{background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));}
    .btn.danger{background: linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.04));}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .kv{display:grid; grid-template-columns:120px 1fr; gap:10px 12px; margin-top:6px}
    .kv div{font-size:13px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08)}
    .footer{margin-top:16px; display:flex; justify-content:space-between; align-items:center}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>智能居住</h1>
          <div class="muted">浏览器订阅二进制 JPEG</div>
        </div>
      </div>
      <div class="row">
        <span class="pill"><span id="statusDot">●</span><span id="statusText">未连接</span></span>
        <span class="pill">FPS: <span id="fps">0</span></span>
        <span class="pill">总帧: <span id="frames">0</span></span>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="card-title">
          <h2>实时画面</h2>
          <div class="row">
            <button id="btnPause" class="btn secondary">暂停</button>
            <button id="btnClear" class="btn secondary">清屏</button>
            <button id="btnFit" class="btn secondary">适应/原始</button>
          </div>
        </div>
        <div class="videoWrap" id="videoWrap">
          <img id="frame" alt="Waiting for frames…" />
          <div id="badge" class="badge warn">等待帧...</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title"><h2>连接 / 订阅</h2></div>
        <div class="kv">
          <div><label for="broker">Broker (WebSocket)</label></div>
          <div><input id="broker" class="mono" value="wss://broker.emqx.io:8084/mqtt" /></div>

          <div><label for="topic">Topic</label></div>
          <div><input id="topic" class="mono" value="image/jpg" /></div>

          <div><label for="clientId">Client ID</label></div>
          <div><input id="clientId" class="mono" /></div>

          <div><label for="qos">QoS</label></div>
          <div>
            <select id="qos">
              <option value="0" selected>0（推荐：视频更流畅）</option>
              <option value="1">1（有确认，容易卡顿）</option>
            </select>
          </div>

          <div><label for="throttle">显示节流 (ms)</label></div>
          <div><input id="throttle" type="number" min="0" step="10" value="40" /></div>

          <div><label>控制</label></div>
          <div class="toolbar">
            <button id="btnConnect" class="btn">连接</button>
            <button id="btnDisconnect" class="btn danger" disabled>断开</button>
            <button id="btnSubscribe" class="btn secondary" disabled>订阅</button>
            <button id="btnUnsub" class="btn secondary" disabled>取消订阅</button>
            <button id="btnCopy" class="btn secondary">复制设置</button>
          </div>
        </div>

        <div class="footer">
          <div class="small muted"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const frame = el('frame');
    const badge = el('badge');
    const statusDot = el('statusDot');
    const statusText = el('statusText');
    const fpsEl = el('fps');
    const framesEl = el('frames');

    const broker = el('broker');
    const topic = el('topic');
    const clientId = el('clientId');
    const qos = el('qos');
    const throttle = el('throttle');

    const btnConnect = el('btnConnect');
    const btnDisconnect = el('btnDisconnect');
    const btnSubscribe = el('btnSubscribe');
    const btnUnsub = el('btnUnsub');
    const btnCopy = el('btnCopy');

    const btnPause = el('btnPause');
    const btnClear = el('btnClear');
    const btnFit = el('btnFit');
    const videoWrap = el('videoWrap');

    let client = null;
    let connected = false;
    let subscribed = false;
    let totalFrames = 0;
    let lastTs = 0;
    let lastUpdate = 0;
    let paused = false;
    let objectUrl = null;
    let fitMode = true; // 适应/原始

    clientId.value = 'webcam_' + Math.random().toString(16).slice(2, 10);

    setInterval(() => {
      const now = performance.now();
      const dt = now - lastTs;
      const fps = dt > 0 ? Math.round(1000 / dt) : 0;
      fpsEl.textContent = isFinite(fps) ? fps : 0;
    }, 500);

    function setStatus(txt, kind='warn'){
      statusText.textContent = txt;
      statusDot.style.color = kind==='ok' ? '#34d399' : kind==='err' ? '#ef4444' : '#f59e0b';
    }
    function setBadge(txt, kind='warn'){
      badge.textContent = txt;
      badge.className = 'badge ' + (kind==='ok'?'ok':kind==='err'?'err':'warn');
      badge.style.display = 'inline-flex';
    }
    function cleanupImage(){
      if (objectUrl){ URL.revokeObjectURL(objectUrl); objectUrl = null; }
    }

    // 适应/原始 两种展示方式
    function applyFit(){
      if (fitMode){
        // 适应：填满容器，等比缩放
        frame.style.width = '100%';
        frame.style.height = '100%';
        frame.style.objectFit = 'contain';
        frame.style.imageRendering = 'auto';
        videoWrap.style.alignItems = 'center';
        videoWrap.style.justifyContent = 'center';
      }else{
        // 原始：按原像素显示（1:1），可滚动查看
        frame.style.width = 'auto';
        frame.style.height = 'auto';
        frame.style.objectFit = 'none';
        frame.style.imageRendering = 'pixelated';
        videoWrap.scrollTop = videoWrap.scrollLeft = 0;
      }
    }

    function onFrame(payload){
      if (paused) return;

      const now = performance.now();
      const gap = Number(throttle.value) || 0;
      if (gap > 0 && now - lastUpdate < gap) return;
      lastUpdate = now;

      cleanupImage();

      const blob = new Blob([payload], { type: 'image/jpeg' });
      objectUrl = URL.createObjectURL(blob);
      frame.src = objectUrl;

      totalFrames++;
      framesEl.textContent = totalFrames;
      lastTs = now;
      setBadge('接收中...', 'ok');
    }

    function connect(){
      if (connected){ return; }
      setBadge('连接中...'); setStatus('连接中...');
      btnConnect.disabled = true; btnDisconnect.disabled = false;

      const url = broker.value.trim();
      const cid = clientId.value.trim() || ('webcam_' + Math.random().toString(16).slice(2,10));

      client = mqtt.connect(url, {
        clientId: cid, clean: true, reconnectPeriod: 2000, connectTimeout: 15000, protocolVersion: 4, resubscribe: false
      });

      client.on('connect', () => {
        connected = true; setStatus('已连接','ok'); setBadge('未订阅','warn');
        btnSubscribe.disabled = false; btnUnsub.disabled = true;
      });

      client.on('reconnect', () => setStatus('自动重连中...'));
      client.on('close', () => {
        connected = false; subscribed = false;
        setStatus('已断开'); setBadge('已断开','err');
        btnConnect.disabled = false; btnDisconnect.disabled = true;
        btnSubscribe.disabled = true; btnUnsub.disabled = true;
      });
      client.on('error', (err) => { setStatus('错误：' + (err?.message || err), 'err'); setBadge('连接错误','err'); });
      client.on('message', (_t, payload) => onFrame(payload));
    }

    function disconnect(){
      if (!client) return;
      try{ client.end(true); }catch(_){}
      connected = false; subscribed = false; client = null;
      setStatus('已断开'); setBadge('未连接','warn');
      btnConnect.disabled = false; btnDisconnect.disabled = true;
      btnSubscribe.disabled = true; btnUnsub.disabled = true;
    }

    function subscribe(){
      if (!client || !connected) return;
      const t = topic.value.trim();
      const q = Number(qos.value)||0;
      client.subscribe(t, { qos: q }, (err) => {
        if (err){ setBadge('订阅失败','err'); return; }
        subscribed = true; setBadge(`已订阅：${t}`,'ok');
        btnSubscribe.disabled = true; btnUnsub.disabled = false;
        totalFrames = 0; framesEl.textContent = '0';
      });
    }

    function unsubscribe(){
      if (!client || !connected || !subscribed) return;
      const t = topic.value.trim();
      client.unsubscribe(t, (err)=>{
        if (err){ setBadge('取消订阅失败','err'); return; }
        subscribed = false; setBadge('未订阅','warn');
        btnSubscribe.disabled = false; btnUnsub.disabled = true;
      });
    }

    // 事件
    el('btnConnect').addEventListener('click', connect);
    el('btnDisconnect').addEventListener('click', disconnect);
    el('btnSubscribe').addEventListener('click', subscribe);
    el('btnUnsub').addEventListener('click', unsubscribe);

    el('btnCopy').addEventListener('click', () => {
      const cfg = { broker: broker.value.trim(), topic: topic.value.trim(), qos: Number(qos.value)||0 };
      navigator.clipboard.writeText(JSON.stringify(cfg,null,2));
      setBadge('已复制设置', 'ok');
      setTimeout(()=>setBadge(subscribed?`已订阅：${topic.value}`:'未订阅', subscribed?'ok':'warn'), 800);
    });

    el('btnPause').addEventListener('click', () => {
      paused = !paused;
      el('btnPause').textContent = paused ? '继续' : '暂停';
      setBadge(paused ? '已暂停' : (subscribed?'接收中...':'未订阅'), paused ? 'warn' : 'ok');
    });

    el('btnClear').addEventListener('click', () => {
      cleanupImage(); frame.removeAttribute('src');
      setBadge(subscribed?'等待下一帧...':'未订阅', 'warn');
    });

    el('btnFit').addEventListener('click', () => {
      fitMode = !fitMode; applyFit();
      setBadge(fitMode?'自适应显示':'原始像素', 'ok');
      setTimeout(()=>setBadge(subscribed?'接收中...':'未订阅', subscribed?'ok':'warn'), 800);
    });

    // 初始状态：自适应显示
    applyFit();
    setBadge('未连接','warn'); setStatus('未连接','warn');
  </script>
</body>
</html>
